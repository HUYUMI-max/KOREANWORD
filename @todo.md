# プロジェクトのTODOリスト

## 優先度：高
- [ ] プロジェクトの基本構造の確認と整理
- [ ] 必要なコンポーネントの実装
- [ ] データベース設計と実装
- [ ] 認証機能の実装

## 優先度：中
- [ ] UI/UXの改善
- [ ] パフォーマンス最適化
- [ ] エラーハンドリングの実装
- [ ] テストの実装

## 優先度：低
- [ ] ドキュメントの整備
- [ ] コードのリファクタリング
- [ ] デプロイメント設定の確認

## 注意事項
- セキュリティ面での考慮が必要
- ユーザビリティの向上に注力
- パフォーマンスの最適化を意識

GET使ってるファイル
src\app\api\folders\route.ts
src\app\api\folders\[folderName]\words\route.ts

sidebarで使っている？　クライアント
wordActions.tsで使っている？　クライアント
folderAction.tsで使っている？　クライアント

## お気に入り機能の問題追跡

### 解決済みの問題
- [x] Firebaseの単語の星マークをクリックしてもすぐにUIに反映されない（ページ更新で反映）
  - SWRの設定更新と状態管理の改善により解決

### 現在の問題
- [ ] 🔴 お気に入り状態変更時の位置管理の問題
  - 発生条件：2番目以降の単語をお気に入り状態に変更時
  - 症状：
    1. 最初の単語に戻ってしまう
    2. シャッフル状態が解除される
  - 影響：単語数が多い場合の使い勝手が悪化
  - 優先度：高（即時対応が必要）

- [ ] 🟡 お気に入り状態変更時に一瞬単語が消える
  - 発生条件：Firebaseの単語をお気に入り状態に変更時
  - 影響：一瞬の表示問題で、ユーザー体験への影響は限定的
  - 優先度：中（後日対応可能）

### 考えられる原因
1. 状態更新の順序とタイミング
   - `mutate`と`setCards`の実行順序による問題
   - `filteredCards`の更新タイミングと`index`の同期が取れていない
   - シャッフル状態の管理が適切に行われていない

2. 一瞬の表示問題
   - 楽観的UI更新と実際のデータ更新の間のタイミング
   - 状態更新の順序による一時的な不整合

### 次の調査ステップ
1. 状態管理の改善
   - `filteredCards`の更新タイミングの見直し
   - シャッフル状態の保持方法の検討
   - 状態更新の順序の最適化

2. インデックス管理の修正
   - 現在の単語の位置を維持する方法の再検討
   - シャッフル状態を考慮した位置管理の実装
   - 状態更新時の位置計算ロジックの改善

### 実施した修正
1. SWRの設定更新
   - revalidateOnFocus: true を追加
   - revalidateOnReconnect: true を追加
   - dedupingInterval: 2000 を追加

2. 状態管理の改善
   - 楽観的UI更新の実装
   - 強制的な再検証の追加
   - 状態の強制更新の実装
   - インデックス保持の試行（未解決）

### 今後の対応方針
1. 状態管理の完全な見直し
   - シャッフル状態の保持方法の改善
   - 状態更新の順序の最適化
   - インデックス管理の再実装

2. 表示問題の改善（優先度低）
   - 状態更新の順序の見直し
   - 必要に応じてUIの改善

## ビルドエラーの履歴と対応状況

### 2024-03-XX お気に入り機能のAPIエンドポイント修正

#### 発生したエラー
1. 最初のエラー
   - ファイル: `src/app/api/folders/[folderName]/words/[wordId]/favorite/route.ts`
   - エラー内容: 型定義の不一致（`params`の型が`Promise<any>`を要求）
   - 対応: `RouteContext`型を追加し、パラメータの受け取り方を修正

2. 2回目のエラー
   - 同じファイルで型エラーが継続
   - エラー内容: `ParamCheck<RouteContext>`の制約を満たしていない
   - 対応: カスタム型を削除し、直接パラメータを受け取る形に修正

3. 3回目のエラー
   - 同じファイルで型エラーが継続
   - 対応: 他のAPIエンドポイントを参考に`context: any`を使用する形に修正
   - 変更内容：
     - `context`パラメータの型を`any`に変更
     - `params`の分割代入を`context.params`から行うように変更
     - 戻り値の型指定を削除

#### 現在の状況
- [~] 🟡 ビルドエラーの修正を試行中
- [ ] 🔴 最終的な解決の確認待ち

#### 次の対応方針
1. ビルドを実行して修正の効果を確認
2. 必要に応じて他のAPIエンドポイントの実装も同様に修正
3. 型安全性を確保するための長期的な改善計画の検討

#### 注意点
- 型エラーの解決には、Next.jsのバージョンに応じた正確な型定義が必要
- APIエンドポイントの実装は、App Routerの仕様に完全に準拠する必要がある
- `any`型の使用は一時的な解決策であり、将来的にはより型安全な実装を検討する必要がある

## 今回のブランチでの変更内容

### お気に入り機能の実装

#### 実装した機能
1. お気に入り状態の管理
   - `Flashcard`型に`isFavorite`フィールドを追加
   - お気に入り状態の切り替え機能を実装
   - お気に入りのみ表示フィルター機能を追加

2. データ永続化
   - Firebaseモード：Firestoreに`isFavorite`状態を保存
   - レベルモード：localStorageに`isFavorite`状態を保存

3. UI実装
   - お気に入りボタン（★/☆）の追加
   - お気に入りフィルターボタンの追加
   - 状態変更時のアニメーション効果

#### 対応した問題
1. お気に入り状態の即時反映
   - SWRの設定を最適化（revalidateOnFocus, revalidateOnReconnect）
   - 楽観的UI更新の実装
   - 状態管理の改善

2. ビルドエラー
   - Next.jsのApp Routerの型定義に合わせた修正
   - APIエンドポイントの型エラーを解消

#### 残っている課題
1. お気に入り状態変更時の位置管理
   - 2番目以降の単語をお気に入り状態に変更時に最初の単語に戻る問題
   - シャッフル状態が解除される問題

2. 表示の一時的な問題
   - お気に入り状態変更時に一瞬単語が消える問題

#### 次のステップ
1. 位置管理の問題の解決
   - 現在の単語の位置を維持する機能の実装
   - シャッフル状態の保持方法の改善

2. 表示問題の改善
   - 状態更新の順序の最適化
   - UIの改善（必要に応じて）

3. 型安全性の向上
   - APIエンドポイントの型定義の改善
   - より型安全な実装への移行